
## Authorization Code Flow

- [OpenID Configuration Endpoint](#openid-configuration-endpoint)
- [User Registration Endpoint](#user-registration-endpointユーザ登録エンドポイント)
- [Authorization Endpoint](#authorization-endpoint認可エンドポイント)
- [Token Endpoint](#token-endpointトークンエンドポイント)
- [Token Revocation Endpoint](#token-revocation-endpointトークン無効化エンドポイント)
- [Token Introspection Endpoint](#token-introspection-endpoint)
- [JWKs Endpoint](#jwks-endpointjwksエンドポイント)
- [UserInfo Endpoint](#userinfo-endpoint属性取得エンドポイント)
- [End Session Endpoint](#end-session-endpointログアウトエンドポイント)

### OpenID Configuration Endpoint

- URI: `/.well-known/openid-configuration`
- HTTP Methods: `GET/POST`

#### Parameters

N/A

#### Response

afterward

#### References

- [OpenID Connect Discovery 1.0](https://openid.net/specs/openid-connect-discovery-1_0.html)

### User Registration Endpoint

- URI: `/sign_up`
- HTTP Methods: `GET`

If parameters are valid, even if the user is already logged in to MFID, it will be logged out and the user registration screen will always be displayed. After completing user registration and verifying the identity of the email address, the parameters passed to this endpoint will be inherited and redirected to the authorization endpoint. If the application is auto-authorized (skip authorization), it will be redirected to the specified redirect_uri with code and state.

#### Parameters

Parameter|Required?|Description
---|---|---
client_id|yes|Please specify the Client ID provided at the time of application registration.
redirect_uri|yes|Specify the full URL (or custom URI scheme) that you set when registering your application.
response_type|yes|Specify a string called `code`.
scope|yes|For multiple selection, please separate them with spaces.
state||It is used as a defend against CSRF to confirm that it is the same session. Specify a sufficiently long random string generated by your application for each request.
code_challenge||Used when using PKCE (Mitigating Authorization Code Interception Attacks). Please specify a value generated by the client using a generation method that conforms to RFC 7636.
code_challenge_method||Please specify `code_challenge` when using PKCE as well. You can use `plain` or `S256`.
ui_locales||Specify the language (ja/en) displayed in MFID

#### Response

Parameter|Required?|Description
---|---|---
code|yes|authorization code.
state|yes|State value specified at the time of request returned only when the state at the time of ※Authorization request is specified. It is used as a defend against CSRF to check if the state value specified at the time of the request matches the state value obtained in the response.


### Authorization Endpoint（認可エンドポイント）

- URI: `/oauth/authorize`
- HTTP Methods: `GET/POST`

#### リクエストパラメータ

パラメータ|必須|概要
---|---|---
client_id|○|アプリケーション登録時に発行されたClient IDを指定してください。
redirect_uri|○|アプリケーション登録時に設定したフルURL（もしくはカスタムURIスキーム）を指定してください。
response_type|○|`code` という文字列を指定してください。
scope|○|複数選択する場合はスペース区切りで指定します。
state||CSRF対策として、同一のセッションであることを確認するために利用します。リクエストごとにアプリケーション側で生成した十分な長さのランダムな文字列を指定してください。
code_challenge||PKCE（認可コード横取り攻撃対策）を利用する場合に利用します。RFC 7636に準拠した生成方法でクライアントで生成した値を指定してください。
code_challenge_method||`code_challenge` 同様にPKCEを利用する場合に指定してください。`plain` または `S256` が利用できます。
unauthenticated_fallback||ユーザが未ログイン状態のときに遷移する画面が指定できます。<br>**signup** : ユーザ登録画面に遷移します。<br>未指定またはそれ以外の場合はログイン画面に遷移します。
prompt||ユーザーに強制させたいアクションを指定します。<br>**login**: ログイン画面を強制的に表示させます。ユーザが既にMFIDにログイン済みであったとしてもログアウトされます。<br>**select_account**: ログインするアカウントをユーザーに選択させる画面が表示されます。<br/>ログイン済みであれば「そのアカウントを使うか」「別のアカウントでログインするか」を選択する画面が表示されます。前者を選択した場合、再認証は不要です。<br/>ログインしていない場合は、「最後にログインしたアカウントでもう一度ログインするか」「別のアカウントでログインするか」を選択する画面が表示されます。前者を選択した場合、再認証が要求されます。
login_hint||ログイン識別子のヒントとして利用します。指定された値と異なるメールアドレスのユーザでMFIDにログインしている場合、再度ログイン要求を行います。値にはメールアドレスを指定することができます。ただし、必ずしもこの値のユーザでログインするとは限らない点に注意してください。
ui_locales||MFIDで表示される言語（ja/en）を指定します

#### レスポンス

パラメータ|必須|概要
---|---|---
code|○|認可コード。
state|○|リクエスト時に指定されたstate値 ※Authorizationリクエスト時のstateが指定されている場合のみ返却されます。CSRF対策として、リクエスト時に指定したstate値とレスポンスで取得したstate値の一致を確認してください。

#### 参考

- [OpenID Connect Core 1.0 - Authorization Endpoint](https://openid.net/specs/openid-connect-core-1_0.html#AuthorizationEndpoint)
- [Proof Key for Code Exchange by OAuth Public Clients](https://tools.ietf.org/html/rfc7636)

### Token Endpoint（トークンエンドポイント）

このエンドポイントには有効なアクセストークンを取得するための2つの方法（「アクセストークン新規取得」「アクセストークン更新」）があります。

- URI: `/oauth/token`
- HTTP Methods: `POST`


#### リクエストヘッダ（アクセストークン新規取得時、更新時共通）

このエンドポイントはBASIC認証を用いたクライアント認証を行う必要があります。
Client IDとClient Secretをコロン（":"）で連結し、Base64エンコードした値をAuthorizationヘッダで送ってください。

#### リクエストパラメータ（アクセストークン新規取得時）

パラメータ|必須|概要
---|---|---
grant_type|○|`authorization_code` という文字列を指定してください。
client_id|※|アプリケーション登録時に発行されたClient IDを指定してください。
client_secret|※|アプリケーション登録時に発行されたClient Secretを指定してください。
code|○|Authorizationエンドポイントで取得した認可コードの文字列を指定してください。有効期限は10分間です。
redirect_uri|○|アプリケーション登録時に設定したフルURL（もしくはカスタムURIスキーム）を指定してください。
code_verifier||PKCE（認可コード横取り攻撃対策）を利用する場合に利用します。認可リクエスト時に利用したcode_verifierを指定してください。

※ client_id, client_secretをリクエストパラメータで送ることは非推奨です。リクエストヘッダでクライアント認証をできない環境である場合のみ使ってください。可能である場合はリクエストヘッダでの認証を推奨します。

#### レスポンス（アクセストークン新規取得時）

パラメータ|必須|概要
---|---|---
access_token|○|APIへアクセスするためのアクセストークン。
token_type|○|Token Type。Web APIへアクセスする際にAccess Tokenを適切に用いるために必要な情報を提供します。Bearer Token形式です。
expires_in|○|Access Tokenの有効期限を表す秒数です。
refresh_token|○|Refresh Token。Access Tokenを更新するときに使用します。
scope|○|発行されたアクセストークンのスコープ。
created_at|○|アクセストークンの作成日時。
id_token|○|ID Token。ユーザー認証情報を含む改ざん検知用の署名付きトークンです。

#### リクエストパラメータ（アクセストークン更新時）

パラメータ|必須|概要
---|---|---
grant_type|○|`refresh_token` という文字列を指定してください。
refresh_token|○|アクセストークン新規取得時に発行されたRefresh Tokenを指定してください。
client_id|※|アプリケーション登録時に発行されたClient IDを指定してください。client_idを指定した場合はclient_secretも合わせて指定しないとエラーになります。
client_secret|※|アプリケーション登録時に発行されたClient Secretを指定してください。

※ client_id, client_secretをリクエストパラメータで送ることは非推奨です。リクエストヘッダでクライアント認証をできない環境である場合のみ使ってください。可能である場合はリクエストヘッダでの認証を推奨します。

#### レスポンス（アクセストークン更新時）

パラメータ|必須|概要
---|---|---
access_token|○|APIへアクセスするためのアクセストークン。
token_type|○|Token Type。Web APIへアクセスする際にAccess Tokenを適切に用いるために必要な情報を提供します。Bearer Token形式です。
expires_in|○|Access Tokenの有効期限を表す秒数です。
refresh_token|○|Refresh Token。Access Tokenを更新するときに使用します。
scope|○|発行されたアクセストークンのスコープ。
created_at|○|アクセストークンの作成日時。
id_token|○|ID Token。ユーザー認証情報を含む改ざん検知用の署名付きトークンです。

#### 参考

- [OpenID Connect Core 1.0 - Token Endpoint](https://openid.net/specs/openid-connect-core-1_0.html#TokenEndpoint)

### Token Revocation Endpoint（トークン無効化エンドポイント）

- URI: `/oauth/revoke`
- HTTP Methods: `POST`

#### リクエストヘッダ（アクセストークン新規取得時、更新時共通）

このエンドポイントはBASIC認証を用いたクライアント認証を行う必要があります。
Client IDとClient Secretをコロン（":"）で連結し、Base64エンコードした値をAuthorizationヘッダで送ってください。

#### リクエストパラメータ

パラメータ|必須|概要
---|---|---
client_id|※|アプリケーション登録時に発行されたClient IDを指定してください。
client_secret|※|アプリケーション登録時に発行されたClient Secretを指定してください。
token|○|無効化したいアクセストークンまたはリフレッシュトークンを指定してください。

※ client_id, client_secretをリクエストパラメータで送ることは非推奨です。リクエストヘッダでクライアント認証をできない環境である場合のみ使ってください。可能である場合はリクエストヘッダでの認証を推奨します。

#### レスポンス

※ 空のjsonが返ります

#### 参考

- [RFC7009 OAuth 2.0 Token Revocation](https://tools.ietf.org/html/rfc7009)

### Token Introspection Endpoint

- URI: `/oauth/introspect`
- HTTP Methods: `POST`

#### リクエストヘッダ（アクセストークン新規取得時、更新時共通）

このエンドポイントはBASIC認証を用いたクライアント認証を行う必要があります。
Client IDとClient Secretをコロン（":"）で連結し、Base64エンコードした値をAuthorizationヘッダで送ってください。

#### リクエストパラメータ

パラメータ|必須|概要
---|---|---
client_id|※|アプリケーション登録時に発行されたClient IDを指定してください。
client_secret|※|アプリケーション登録時に発行されたClient Secretを指定してください。
token|○|確認対象のアクセストークンを指定してください。

※ client_id, client_secretをリクエストパラメータで送ることは非推奨です。リクエストヘッダでクライアント認証をできない環境である場合のみ使ってください。可能である場合はリクエストヘッダでの認証を推奨します。

#### レスポンス

パラメータ|必須|概要|サンプル
---|---|---|---
active|○|指定されたアクセストークンの有効性です。|true
scope||指定されたアクセストークンのscopeです。|"openid email profile address"
client_id||指定されたアクセストークンのClient IDです。|"bcdeb0f1b654"
token_type||指定されたアクセストークンの種別です。|"Bearer"
exp||指定されたアクセストークンが失効する時間です。(UNIX time)|1539251579
iat||指定されたアクセストークンが発行された時間です。（UNIX time)|1539244379
sub||指定されたアクセストークのリソースオーナーのユーザ識別子です。|"12345"

#### 参考

- [RFC7662 OAuth 2.0 Token Introspection](https://tools.ietf.org/html/rfc7662)

### JWKs Endpoint（JWKsエンドポイント）

- URI: `/oauth/discovery/keys`
- HTTP Methods: `GET`

#### リクエストパラメータ

なし

#### レスポンス

パラメータ|概要
---|---
keys|JWKの値の配列。
kid|ID TokenのHeaderに含まれているKey ID。
e|exponent。Public Keyを復元するための暗号化指数。
n|modulus。Public Keyを復元するための公開鍵の絶対値。
use|公開鍵の利用用途。"sig"はsignatureを意味し、署名検証目的で提供していることを示します。
alg|署名検証のアルゴリズム


### UserInfo Endpoint（属性取得エンドポイント）

- URI: `/oauth/userinfo`
- HTTP Methods: `GET/POST`

#### リクエストヘッダー

フィールド|必須|概要
---|---|---
Authorization|○|Access Tokenの文字列を指定してください。（Bearer Token形式）

#### リクエストパラメータ

フィールド|必須|概要
---|---|---
access_token|○|Access Tokenの文字列を指定してください

#### レスポンス

パラメータ|概要|必要なscope|サンプル
---|---|---|---
sub|ユーザ識別子|openid|"abcde"
identification_code|（外部サービスに送信しても良い）ユーザ識別子\[12桁\]|openid|"123456789012"
email|メールアドレス|email|"moneyforward@example.com"
email_verified|メールアドレス確認済みステータス|email|true
gender|性別|profile|"male"
birthdate|生年（月日は含まない）|profile|"1986"
address|-|-|-
postal_code|郵便番号|address|"1080023"
region|都道府県|address|"東京都"


#### 参考

- [OpenID Connect Core 1.0 - UserInfo Endpoint](https://openid.net/specs/openid-connect-core-1_0.html#UserInfo)


### End Session Endpoint（ログアウトエンドポイント）

- URI: `/end_session`
- HTTP Methods: `GET`

パラメータが有効であれば、ユーザがMFIDにログイン済みであってもログアウトされ、指定されたURL（post_logout_redirect_uri）にリダイレクトします。RPをログアウトした際に、OP側もログアウトさせたい場合に利用してください。

#### リクエストパラメータ

フィールド|必須|概要
---|---|---
client_id|○|アプリケーション登録時に発行されたClient IDを指定してください。
post_logout_redirect_uri|○|アプリケーション登録時に設定したフルURL（もしくはカスタムURIスキーム）を指定してください。

#### 参考

- [OpenID Connect Session Management 1.0 - RP-Initiated Logout](https://openid.net/specs/openid-connect-session-1_0.html#RPLogout)
