
## Authorization Code Flow

- [OpenID Configuration Endpoint](#openid-configuration-endpoint)
- [User Registration Endpoint](#user-registration-endpointユーザ登録エンドポイント)
- [Authorization Endpoint](#authorization-endpoint認可エンドポイント)
- [Token Endpoint](#token-endpointトークンエンドポイント)
- [Token Revocation Endpoint](#token-revocation-endpointトークン無効化エンドポイント)
- [Token Introspection Endpoint](#token-introspection-endpoint)
- [JWKs Endpoint](#jwks-endpointjwksエンドポイント)
- [UserInfo Endpoint](#userinfo-endpoint属性取得エンドポイント)
- [End Session Endpoint](#end-session-endpointログアウトエンドポイント)

### OpenID Configuration Endpoint

- URI: `/.well-known/openid-configuration`
- HTTP Methods: `GET/POST`

#### Parameters

N/A

#### Response

afterward

#### References

- [OpenID Connect Discovery 1.0](https://openid.net/specs/openid-connect-discovery-1_0.html)

### User Registration Endpoint

- URI: `/sign_up`
- HTTP Methods: `GET`

If parameters are valid, even if the user is already logged in to MFID, it will be logged out and the user registration screen will always be displayed. After completing user registration and verifying the identity of the email address, the parameters passed to this endpoint will be inherited and redirected to the authorization endpoint. If the application is auto-authorized (skip authorization), it will be redirected to the specified redirect_uri with code and state.

#### Parameters

Parameter|Required?|Description
---|---|---
client_id|yes|Please specify the Client ID provided at the time of application registration.
redirect_uri|yes|Specify the full URL (or custom URI scheme) that you set when registering your application.
response_type|yes|Specify a string called `code`.
scope|yes|For multiple selection, please separate them with spaces.
state||It is used as a defend against CSRF to confirm that it is the same session. Specify a sufficiently long random string generated by your application for each request.
code_challenge||Used when using PKCE (Mitigating Authorization Code Interception Attacks). Please specify a value generated by the client using a generation method that conforms to RFC 7636.
code_challenge_method||Please specify `code_challenge` when using PKCE as well. You can use `plain` or `S256`.
ui_locales||Specify the language (`ja`/`en`) displayed in MFID

#### Response

Parameter|Required?|Description
---|---|---
code|yes|Authorization code.
state|yes|State value specified at the time of request returned only when the state at the time of ※Authorization request is specified. It is used as a defend against CSRF to check if the state value specified at the time of the request matches the state value obtained in the response.


### Authorization Endpoint

- URI: `/oauth/authorize`
- HTTP Methods: `GET/POST`

#### Parameters

Parameter|Required?|Description
---|---|---
client_id|yes|Please specify the Client ID provided at the time of application registration.
redirect_uri|yes|Specify the full URL (or custom URI scheme) that you set when registering your application.
response_type|yes|Specify a string called `code`.
scope|yes|For multiple selection, please separate them with spaces.
state||It is used as a defend against CSRF to confirm that it is the same session. Specify a sufficiently long random string generated by your application for each request.
code_challenge||Used when using PKCE (Mitigating Authorization Code Interception Attacks). Please specify a value generated by the client using a generation method that conforms to RFC 7636.
code_challenge_method||Please specify `code_challenge` when using PKCE as well. You can use `plain` or `S256`.
unauthenticated_fallback||You can specify which screen will be displayed if the user is not logged in.<br>**signup** : redirect to the user registration screen.<br>If not specified or otherwise, it will redirect to the login screen.
prompt||Specify the action you want the user to take.<br>**login**: Force the login screen to appear. Even if the user is already logged into MFID, it will be logged out.<br>**select_account**: A screen will appear prompting the user to select an account to login.<br/>If you have already logged in, you will be prompted to select `use this account` or `use others account`. If you choose the `use this account` then no re-authentication is required.<br/>If you are not logged in, a screen will appear asking you to select `Login with the last logged in account` or `Login with another account`. If you choose the `Login with the last logged in account`, you will be asked to re-authenticate.
login_hint||Used as a hint for the login identifier. If a user has email address different from the specified value is logged into MFID, a login request will be made again. You can specify an email address for the value. However, that you are not necessarily logged in as a user with this value.
ui_locales||Specify the language (`ja`/`en`) displayed in MFID

#### Response

Parameter|Required?|Description
---|---|---
code|yes|Authorization code.
state|yes|State value specified at the time of request returned only when the state at the time of ※Authorization request is specified. It is used as a defend against CSRF to check if the state value specified at the time of the request matches the state value obtained in the response.

#### References

- [OpenID Connect Core 1.0 - Authorization Endpoint](https://openid.net/specs/openid-connect-core-1_0.html#AuthorizationEndpoint)
- [Proof Key for Code Exchange by OAuth Public Clients](https://tools.ietf.org/html/rfc7636)

### Token Endpoint

This endpoint has two methods ("Get New Access Token" and "Renew Access Token") to get a valid access token.

- URI: `/oauth/token`
- HTTP Methods: `POST`


#### Request headers（When Get New Access Token or Renew Access Token）

This endpoint should authenticate the client using BASIC authentication.
Concatenate the Client ID and Client Secret with a colon (":") and send the Base64-encoded value in the Authorization header.

#### Parameters（When Get New Access Token）

Parameter|Required?|Description
---|---|---
grant_type|yes|Specify a string called `authorization_code`.
client_id|※|Please specify the Client ID provided at the time of application registration.
client_secret|※|Please specify the Client Secret provided at the time of application registration.
code|yes|Specify the authorization code string obtained from the Authorization endpoint. Valid for 10 minutes.
redirect_uri|yes|Specify the full URL (or custom URI scheme) that you set when registering your application.
code_verifier||Used when using PKCE (Mitigating Authorization Code Interception Attacks). Please specify the `code_verifier` used at the time of authorization request.

※ Sending `client_id` and `client_secret` as request parameters is deprecated.Please use it only when the environment does not allow client authentication in the request header. Authentication via request headers is recommended when possible.

#### Response（When Get New Access Token）

Parameter|Required?|Description
---|---|---
access_token|yes|Access token for accessing the API.
token_type|yes|Token Type. Provides the information necessary to properly use the Access Token when accessing the Web API (format: Bearer Token).
expires_in|yes|The number of seconds that represents the Access Token expiration period.
refresh_token|yes|Refresh Token. Used when updating the Access Token.
scope|yes|The scope of the provided access token.
created_at|yes|The date and time when the access token was created.
id_token|yes|ID Token. A signed token for tamper detection that contains user credentials.

#### Parameters（When Renew Access Token）

Parameter|Required?|Description
---|---|---
grant_type|yes|Specify a string called `refresh_token`.
refresh_token|yes|Please specify the Refresh Token obtained when a new access token is provided.
client_id|※|Please specify the Client ID provided at the time of application registration. If client_id is specified, you need to specify also client_secret to avoid error.
client_secret|※|Please specify the Client Secret provided at the time of application registration.

※ Sending `client_id` and `client_secret` as request parameters is deprecated.Please use it only when the environment does not allow client authentication in the request header. Authentication via request headers is recommended when possible.

#### Response（When Renew Access Token）

Parameter|Required?|Description
---|---|---
access_token|○|Access token for accessing the API.
token_type|○|Token Type. Provides the information necessary to properly use the Access Token when accessing the Web API (format: Bearer Token).
expires_in|○|The number of seconds that represents the Access Token expiration period.
refresh_token|○|Refresh Token. Used when updating the Access Token.
scope|○|The scope of the provided access token.
created_at|○|The date and time when the access token was created.
id_token|○|ID Token. A signed token for tamper detection that contains user credentials.

#### References

- [OpenID Connect Core 1.0 - Token Endpoint](https://openid.net/specs/openid-connect-core-1_0.html#TokenEndpoint)

### Token Revocation Endpoint（トークン無効化エンドポイント）

- URI: `/oauth/revoke`
- HTTP Methods: `POST`

#### リクエストヘッダ（アクセストークン新規取得時、更新時共通）

このエンドポイントはBASIC認証を用いたクライアント認証を行う必要があります。
Client IDとClient Secretをコロン（":"）で連結し、Base64エンコードした値をAuthorizationヘッダで送ってください。

#### リクエストパラメータ

パラメータ|必須|概要
---|---|---
client_id|※|アプリケーション登録時に発行されたClient IDを指定してください。
client_secret|※|アプリケーション登録時に発行されたClient Secretを指定してください。
token|○|無効化したいアクセストークンまたはリフレッシュトークンを指定してください。

※ client_id, client_secretをリクエストパラメータで送ることは非推奨です。リクエストヘッダでクライアント認証をできない環境である場合のみ使ってください。可能である場合はリクエストヘッダでの認証を推奨します。

#### レスポンス

※ 空のjsonが返ります

#### 参考

- [RFC7009 OAuth 2.0 Token Revocation](https://tools.ietf.org/html/rfc7009)

### Token Introspection Endpoint

- URI: `/oauth/introspect`
- HTTP Methods: `POST`

#### リクエストヘッダ（アクセストークン新規取得時、更新時共通）

このエンドポイントはBASIC認証を用いたクライアント認証を行う必要があります。
Client IDとClient Secretをコロン（":"）で連結し、Base64エンコードした値をAuthorizationヘッダで送ってください。

#### リクエストパラメータ

パラメータ|必須|概要
---|---|---
client_id|※|アプリケーション登録時に発行されたClient IDを指定してください。
client_secret|※|アプリケーション登録時に発行されたClient Secretを指定してください。
token|○|確認対象のアクセストークンを指定してください。

※ client_id, client_secretをリクエストパラメータで送ることは非推奨です。リクエストヘッダでクライアント認証をできない環境である場合のみ使ってください。可能である場合はリクエストヘッダでの認証を推奨します。

#### レスポンス

パラメータ|必須|概要|サンプル
---|---|---|---
active|○|指定されたアクセストークンの有効性です。|true
scope||指定されたアクセストークンのscopeです。|"openid email profile address"
client_id||指定されたアクセストークンのClient IDです。|"bcdeb0f1b654"
token_type||指定されたアクセストークンの種別です。|"Bearer"
exp||指定されたアクセストークンが失効する時間です。(UNIX time)|1539251579
iat||指定されたアクセストークンが発行された時間です。（UNIX time)|1539244379
sub||指定されたアクセストークのリソースオーナーのユーザ識別子です。|"12345"

#### 参考

- [RFC7662 OAuth 2.0 Token Introspection](https://tools.ietf.org/html/rfc7662)

### JWKs Endpoint（JWKsエンドポイント）

- URI: `/oauth/discovery/keys`
- HTTP Methods: `GET`

#### リクエストパラメータ

なし

#### レスポンス

パラメータ|概要
---|---
keys|JWKの値の配列。
kid|ID TokenのHeaderに含まれているKey ID。
e|exponent。Public Keyを復元するための暗号化指数。
n|modulus。Public Keyを復元するための公開鍵の絶対値。
use|公開鍵の利用用途。"sig"はsignatureを意味し、署名検証目的で提供していることを示します。
alg|署名検証のアルゴリズム


### UserInfo Endpoint（属性取得エンドポイント）

- URI: `/oauth/userinfo`
- HTTP Methods: `GET/POST`

#### リクエストヘッダー

フィールド|必須|概要
---|---|---
Authorization|○|Access Tokenの文字列を指定してください。（Bearer Token形式）

#### リクエストパラメータ

フィールド|必須|概要
---|---|---
access_token|○|Access Tokenの文字列を指定してください

#### レスポンス

パラメータ|概要|必要なscope|サンプル
---|---|---|---
sub|ユーザ識別子|openid|"abcde"
identification_code|（外部サービスに送信しても良い）ユーザ識別子\[12桁\]|openid|"123456789012"
email|メールアドレス|email|"moneyforward@example.com"
email_verified|メールアドレス確認済みステータス|email|true
gender|性別|profile|"male"
birthdate|生年（月日は含まない）|profile|"1986"
address|-|-|-
postal_code|郵便番号|address|"1080023"
region|都道府県|address|"東京都"


#### 参考

- [OpenID Connect Core 1.0 - UserInfo Endpoint](https://openid.net/specs/openid-connect-core-1_0.html#UserInfo)


### End Session Endpoint（ログアウトエンドポイント）

- URI: `/end_session`
- HTTP Methods: `GET`

パラメータが有効であれば、ユーザがMFIDにログイン済みであってもログアウトされ、指定されたURL（post_logout_redirect_uri）にリダイレクトします。RPをログアウトした際に、OP側もログアウトさせたい場合に利用してください。

#### リクエストパラメータ

フィールド|必須|概要
---|---|---
client_id|○|アプリケーション登録時に発行されたClient IDを指定してください。
post_logout_redirect_uri|○|アプリケーション登録時に設定したフルURL（もしくはカスタムURIスキーム）を指定してください。

#### 参考

- [OpenID Connect Session Management 1.0 - RP-Initiated Logout](https://openid.net/specs/openid-connect-session-1_0.html#RPLogout)
